---
http:
  routers:
    grafana:
      rule: PathPrefix(`/grafana`) {{ .HostRule }}
      entrypoints:
        - websecure
      service: grafana
      tls: true

    loki:
      rule: PathPrefix(`/loki`) {{ .HostRule }}
      entrypoints:
        - websecure
      service: loki
      middlewares:
        - strip-loki-prefix
        - loki-auth
      tls: true

    finch:
      rule: PathPrefix(`/`) {{ .HostRule }}
      entrypoints:
        - websecure
      service: finch
      middlewares:
        - finch-passtls
      tls: true

    dashboard:
      rule: (PathPrefix(`/dashboard`) || PathPrefix(`/ws`) || PathPrefix(`/login`) || PathPrefix(`/logout`)) {{ .HostRule }}
      entrypoints:
        - websecure
      service: dashboard
      tls: true

    mimir:
      rule: PathPrefix(`/mimir`) {{ .HostRule }}
      entrypoints:
        - websecure
      service: mimir
      middlewares:
        - strip-mimir-prefix
        - loki-auth
      tls: true

    pyroscope:
      rule: PathPrefix(`/pyroscope`) {{ .HostRule }}
      entrypoints:
        - websecure
      service: pyroscope
      middlewares:
        - strip-pyroscope-prefix
        - loki-auth
      tls: true

  services:
    grafana:
      loadBalancer:
        servers:
          - url: http://grafana:3000

    loki:
      loadBalancer:
        servers:
          - url: http://loki:3100

    finch:
      loadBalancer:
        servers:
          - url: h2c://finch:3000

    dashboard:
      loadBalancer:
        servers:
          - url: http://finch:3001

    mimir:
      loadBalancer:
        servers:
          - url: http://mimir:8080

    pyroscope:
      loadBalancer:
        servers:
          - url: http://pyroscope:4040

  middlewares:
    strip-loki-prefix:
      stripprefix:
        prefixes:
          - "/loki"

    strip-mimir-prefix:
      stripprefix:
        prefixes:
          - "/mimir"

    strip-pyroscope-prefix:
      stripprefix:
        prefixes:
          - "/pyroscope"

    finch-passtls:
      passtlsclientcert:
        pem: true

tls:
  certificates:
    - certfile: /etc/traefik/certs.d/cert.pem
      keyfile: /etc/traefik/certs.d/key.pem
  options:
    default:
      clientauth:
        clientauthtype: RequestClientCert

