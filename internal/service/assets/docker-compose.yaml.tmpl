---
services:
  grafana:
    container_name: grafana
    image: grafana/grafana:12.3.3
    environment:
      - GF_SERVER_ROOT_URL={{ .RootUrl }}/grafana
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
    volumes:
      - /var/lib/finch/grafana:/var/lib/grafana
      - /var/lib/finch/grafana/alerting:/etc/grafana/provisioning/alerting
    entrypoint:
      - sh
      - -euc
      - |
        mkdir -p /etc/grafana/provisioning/datasources
        cat <<EOF > /etc/grafana/provisioning/datasources/ds.yaml
        apiVersion: 1
        datasources:
        - name: Loki
          type: loki
          uid: finch-loki
          access: proxy
          orgId: 1
          url: http://loki:3100
          basicAuth: false
          isDefault: false
          version: 1
          editable: false
        - name: Mimir
          type: prometheus
          uid: finch-mimir
          access: proxy
          orgId: 1
          url: http://mimir:8080/prometheus
          basicAuth: false
          isDefault: false
          version: 1
          editable: false
        - name: Pyroscope
          type: grafana-pyroscope-datasource
          uid: finch-pyroscope
          access: proxy
          orgId: 1
          url: http://pyroscope:4040
          basicAuth: false
          isDefault: false
          version: 1
          jsonData:
            keepCookies: [pyroscope_git_session]
          editable: false
        EOF
        mkdir -p /etc/grafana/provisioning/dashboards
        cat <<EOF > /etc/grafana/provisioning/dashboards/db.yaml
        apiVersion: 1
        providers:
        - name: 'Finch default dashboards'
          folder: ''
          type: file
          options:
            path: /var/lib/grafana/dashboards
        EOF
        /run.sh
    restart: always
    labels:
      finch.config-hash: "{{ .GrafanaConfigHash }}"

  loki:
    container_name: loki
    image: grafana/loki:3.6.6
    command:
      - "-config.file=/etc/loki/loki.yaml"
      - "-target=all"
      - "-log.level=info"
    volumes:
      - /var/lib/finch/loki/etc:/etc/loki
      - /var/lib/finch/loki/data:/var/lib/loki
    restart: always
    labels:
      finch.config-hash: "{{ .LokiConfigHash }}"

  traefik:
    container_name: traefik
    image: traefik:v3.6.8
    command:
      - "--configfile=/etc/traefik/traefik.yaml"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/finch/traefik/etc:/etc/traefik
    restart: always

  alloy:
    container_name: alloy
    image: grafana/alloy:v1.13.1
    volumes:
      - /var/lib/finch/alloy/etc:/etc/alloy
      - /var/lib/finch/alloy/data:/var/lib/alloy/data
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /run/udev:/host/run/udev:ro
      - /:/host:ro,rslave
    command:
      - "run"
      - "--storage.path=/var/lib/alloy/data"
      - "--disable-reporting=true"
      - "/etc/alloy/alloy.config"
    restart: always
    labels:
      finch.config-hash: "{{ .AlloyConfigHash }}"

  finch:
    container_name: finch
    image: ghcr.io/tschaefer/finch:1.10.0
    volumes:
      - /var/lib/finch:/var/lib/finch
    restart: always

  mimir:
    container_name: mimir
    image: grafana/mimir:3.0.3
    volumes:
      - /var/lib/finch/mimir/data:/var/lib/mimir
      - /var/lib/finch/mimir/etc:/etc/mimir
    command:
      - "--config.file=/etc/mimir/mimir.yaml"
    user: "10001:10001"
    restart: always
    labels:
      finch.config-hash: "{{ .MimirConfigHash }}"

  pyroscope:
    container_name: pyroscope
    image: grafana/pyroscope:1.18.1
    volumes:
      - /var/lib/finch/pyroscope/data:/var/lib/pyroscope
    command:
      - "--pyroscopedb.data-path=/var/lib/pyroscope"
      - "--compactor.blocks-retention-period=72h"
      - "--querier.max-query-lookback=72h"
      - "--querier.max-query-length=72h"
      - "--server.log-source-ips-enabled=true"
    user: "10001:10001"
    restart: always

  hc-traefik:
    container_name: hc-traefik
    image: curlimages/curl:8.17.0
    entrypoint:
      - sleep
      - infinity
    healthcheck:
      test: ["CMD-SHELL", "curl -so /dev/null -w '%{http_code}' http://traefik:80 | grep -qE '^[234][0-9]{2}$' && curl -sko /dev/null -w '%{http_code}' https://traefik:443 | grep -qE '^[234][0-9]{2}$'"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s
    depends_on:
      - traefik
    restart: always

  hc-finch:
    container_name: hc-finch
    image: curlimages/curl:8.17.0
    entrypoint:
      - sleep
      - infinity
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://finch:3003/healthz"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s
    depends_on:
      - finch
    restart: always

  hc-grafana:
    container_name: hc-grafana
    image: curlimages/curl:8.17.0
    entrypoint:
      - sleep
      - infinity
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://grafana:3000/api/health"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s
    depends_on:
      - grafana
    restart: always

  hc-loki:
    container_name: hc-loki
    image: curlimages/curl:8.17.0
    entrypoint:
      - sleep
      - infinity
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://loki:3100/ready"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s
    depends_on:
      - loki
    restart: always

  hc-mimir:
    container_name: hc-mimir
    image: curlimages/curl:8.17.0
    entrypoint:
      - sleep
      - infinity
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://mimir:8080/ready"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s
    depends_on:
      - mimir
    restart: always

  hc-pyroscope:
    container_name: hc-pyroscope
    image: curlimages/curl:8.17.0
    entrypoint:
      - sleep
      - infinity
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://pyroscope:4040/ready"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s
    depends_on:
      - pyroscope
    restart: always

networks:
  default:
    name: finch
    driver: bridge
    attachable: true
    enable_ipv6: true
    driver_opts:
      com.docker.network.container_iface_prefix: "finch"
