---
services:
  grafana:
    container_name: grafana
    image: grafana/grafana:12.3.2
    environment:
      - GF_SERVER_ROOT_URL={{ .RootUrl }}/grafana
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
    volumes:
      - /var/lib/finch/grafana:/var/lib/grafana
    entrypoint:
      - sh
      - -euc
      - |
        mkdir -p /etc/grafana/provisioning/datasources
        cat <<EOF > /etc/grafana/provisioning/datasources/ds.yaml
        apiVersion: 1
        datasources:
        - name: Loki
          type: loki
          uid: finch-loki
          access: proxy
          orgId: 1
          url: http://loki:3100
          basicAuth: false
          isDefault: false
          version: 1
          editable: false
        - name: Mimir
          type: prometheus
          uid: finch-mimir
          access: proxy
          orgId: 1
          url: http://mimir:8080/prometheus
          basicAuth: false
          isDefault: false
          version: 1
          editable: false
        - name: Pyroscope
          type: grafana-pyroscope-datasource
          uid: finch-pyroscope
          access: proxy
          orgId: 1
          url: http://pyroscope:4040
          basicAuth: false
          isDefault: false
          version: 1
          jsonData:
            keepCookies: [pyroscope_git_session]
          editable: false
        EOF
        mkdir -p /etc/grafana/provisioning/dashboards
        cat <<EOF > /etc/grafana/provisioning/dashboards/db.yaml
        apiVersion: 1
        providers:
        - name: 'Finch default dashboards'
          folder: ''
          type: file
          options:
            path: /var/lib/grafana/dashboards
        EOF
        /run.sh
    restart: always

  loki:
    container_name: loki
    image: grafana/loki:3.6.4
    command:
      - "-config.file=/etc/loki/loki.yaml"
      - "-target=all"
      - "-log.level=info"
    volumes:
      - /var/lib/finch/loki/etc:/etc/loki
      - /var/lib/finch/loki/data:/var/lib/loki
    restart: always

  traefik:
    container_name: traefik
    image: traefik:v3.6.7
    command:
      - "--configfile=/etc/traefik/traefik.yaml"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/finch/traefik/etc:/etc/traefik
    restart: always

  alloy:
    container_name: alloy
    image: grafana/alloy:v1.12.2
    volumes:
      - /var/lib/finch/alloy/etc:/etc/alloy
      - /var/lib/finch/alloy/data:/var/lib/alloy/data
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /run/udev:/host/run/udev:ro
      - /:/host:ro,rslave
    command:
      - "run"
      - "--storage.path=/var/lib/alloy/data"
      - "--disable-reporting=true"
      - "/etc/alloy/alloy.config"
    restart: always

  finch:
    container_name: finch
    image: ghcr.io/tschaefer/finch:1.6.2
    volumes:
      - /var/lib/finch:/var/lib/finch
    restart: always

  mimir:
    container_name: mimir
    image: grafana/mimir:3.0.2
    volumes:
      - /var/lib/finch/mimir/data:/var/lib/mimir
      - /var/lib/finch/mimir/etc:/etc/mimir
    command:
      - "--config.file=/etc/mimir/mimir.yaml"
    user: "10001:10001"
    restart: always

  pyroscope:
    container_name: pyroscope
    image: grafana/pyroscope:1.18.0
    volumes:
      - /var/lib/finch/pyroscope/data:/var/lib/pyroscope
    command:
      - "--pyroscopedb.data-path=/var/lib/pyroscope"
      - "--compactor.blocks-retention-period=72h"
      - "--querier.max-query-lookback=72h"
      - "--querier.max-query-length=72h"
      - "--querier.max-query-lookback=72h"
      - "--server.log-source-ips-enabled=true"
    user: "10001:10001"
    restart: always

networks:
  default:
    name: finch
    driver: bridge
    attachable: true
    enable_ipv6: true
    driver_opts:
      com.docker.network.container_iface_prefix: "finch"
